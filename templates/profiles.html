{% extends 'base.html' %}

{% block title %}Perfiles - Netflix{% endblock %}

{% block content %}
<div class="container">
  <h2>Perfiles</h2>
  <p>Gestiona los perfiles de tu cuenta.</p>

  <div style="margin-top:1rem; margin-bottom:1rem;">
    {% if not deletion_required %}
    <form method="post" action="{{ url_for('create_profile') }}" class="d-flex gap-2">
      <input name="profile_name" class="form-control" placeholder="Nombre del perfil" required>
      <select name="profile_type" class="form-select" style="max-width:160px;">
        <option value="standard">Estándar</option>
        <option value="kids">Kids</option>
      </select>
      <button class="btn btn-danger">Crear</button>
    </form>
    {% else %}
    <div class="alert alert-warning">
      <strong>Acción requerida:</strong>
      {% if target_plan %}
        Para cambiar a <strong>{{ target_plan.upper() }}</strong> debes eliminar al menos <strong>{{ needed }}</strong> perfil(es).
      {% else %}
        Debes eliminar al menos <strong>{{ needed }}</strong> perfil(es) antes de cambiar de plan.
      {% endif %}
      <div style="margin-top:0.5rem; color:#eee;">Usa los botones "Eliminar" en cada perfil para reducir la cantidad.</div>
    </div>
    {% endif %}
  </div>

  <div class="row">
    {% if profiles and profiles|length > 0 %}
      {% for p in profiles %}
      <div class="col-md-3">
        <div class="card" style="background:#222; padding:1rem; margin-bottom:1rem;">
          <h5 style="color:#fff;">{{ p.profile_name }}</h5>
          <p style="color:#aaa;">Tipo: {{ p.profile_type }}</p>
          {% if selected_profile and selected_profile.id == p.id %}
            <span class="badge bg-success">Seleccionado</span>
          {% else %}
            <form method="post" action="{{ url_for('switch_profile') }}">
              <input type="hidden" name="profile_id" value="{{ p.id }}">
              <button class="btn btn-sm btn-outline-light">Seleccionar</button>
            </form>
          {% endif %}
          <div style="margin-top:0.5rem;">
            <button class="btn btn-sm btn-outline-danger btn-delete-profile" data-id="{{ p.id }}">Eliminar</button>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <div class="alert alert-info" role="alert">
          No se encontraron perfiles para tu cuenta. Crea uno usando el formulario arriba.
          <br>
          <small style="color:#ddd;">(Depuración: user_id={{ current_user.id }}, encontrados={{ profiles_count if profiles_count is defined else 0 }})</small>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

  {% block extra_js %}
  <script>
  document.querySelectorAll('.btn-delete-profile').forEach(btn => {
    btn.addEventListener('click', async function() {
      const pid = this.dataset.id;
      if (!confirm('¿Eliminar este perfil y su lista de reproducción asociada? Esta acción no se puede deshacer.')) return;
      try {
        const res = await fetch('{{ url_for("delete_profile") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profile_id: parseInt(pid) })
        });
        const data = await res.json();
        if (res.ok && data.success) {
          showToast('Perfil eliminado', 'success');
          setTimeout(() => location.reload(), 400);
        } else {
          showToast(data.message || 'No se pudo eliminar el perfil', 'warning');
        }
      } catch (err) {
        console.error(err);
        showToast('Error de red al eliminar perfil', 'danger');
      }
    });
  });
  </script>
  {% endblock %}
