{% extends 'base.html' %}

{% block title %}Series - Netflix{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/catalog.css') }}">
{% endblock %}

{% block content %}
<div class="catalog-container">
    <div class="catalog-header">
        <h2><i class="fas fa-tv"></i> Todas las Series</h2>
        {% if profiles and profiles|length > 0 %}
        <div class="profile-selector" style="margin-left:auto;">
            <label for="profile-select" style="margin-right:0.5rem;color:#ddd;">Perfil:</label>
            <select id="profile-select" class="form-select form-select-sm" style="display:inline-block; width:auto;">
                {% for p in profiles %}
                    <option value="{{ p.id }}" {% if current_profile_id and current_profile_id == p.id %}selected{% endif %}>{{ p.profile_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    {% if series_list and series_list|length > 0 %}
        <div class="catalog-grid">
            {% for series in series_list %}
                <div class="card">
                    <a href="{{ url_for('series_detail', series_id=series.id) }}" class="card-link">
                        {% if series.image_url %}
                            <img src="{{ series.image_url }}" alt="{{ series.title }}">
                        {% else %}
                            <img src="https://via.placeholder.com/300x450?text={{ series.title|replace(' ', '+') }}" alt="{{ series.title }}">
                        {% endif %}
                    </a>

                    {% if series.imdb_rating %}
                    <div class="card-rating">
                        <i class="fas fa-star"></i> {{ series.imdb_rating }}
                    </div>
                    {% endif %}

                    <div class="card-body">
                        <h3 class="card-title">{{ series.title }}</h3>
                        <p class="card-desc">{{ series.total_seasons }} Temporada(s)</p>
                        <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                            {% if current_user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-light btn-add-watchlist" data-id="{{ series.id }}" data-type="series">A침adir a Mi Lista</button>
                            {% else %}
                                <a class="btn btn-sm btn-outline-light" href="{{ url_for('login') }}">Inicia sesi칩n para guardar</a>
                            {% endif %}
                            <a class="btn btn-sm btn-light" href="{{ url_for('play_series', series_id=series.id) }}">Ver</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="catalog-empty">
            <i class="fas fa-tv-alt"></i>
            <h3>No hay series disponibles</h3>
            <p>Vuelve m치s tarde para ver nuevo contenido.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // A침adir a Mi Lista - usa la API /add-to-watchlist
    document.querySelectorAll('.btn-add-watchlist').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const contentId = this.dataset.id;
            const contentType = this.dataset.type;
            this.disabled = true;
            const original = this.innerText;
            this.innerText = 'Guardando...';
            try {
                // Obtener profile seleccionado si existe
                const profileSelect = document.getElementById('profile-select');
                const profileId = profileSelect ? profileSelect.value : null;

                const payload = { content_id: contentId, content_type: contentType };
                if (profileId) payload.profile_id = parseInt(profileId);

                const res = await fetch("{{ url_for('add_to_watchlist') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showToast(data.message || 'Agregado a tu lista', 'success');
                    this.innerText = 'Guardado';
                } else {
                    showToast(data.message || 'No se pudo agregar', 'warning');
                    this.innerText = original;
                    this.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast('Error de red al guardar', 'danger');
                this.innerText = original;
                this.disabled = false;
            }
        });
    });
</script>
{% endblock %}
