{% extends 'base.html' %}

{% block title %}Películas - Netflix{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/catalog.css') }}">
{% endblock %}

{% block content %}
<div class="catalog-container">
    <div class="catalog-header">
        <h2><i class="fas fa-film"></i> Todas las Películas</h2>
        {% if profiles and profiles|length > 0 %}
        <div class="profile-selector" style="margin-left:auto;">
            <label for="profile-select" style="margin-right:0.5rem;color:#ddd;">Perfil:</label>
            <select id="profile-select" class="form-select form-select-sm" style="display:inline-block; width:auto;">
                {% for p in profiles %}
                    <option value="{{ p.id }}" {% if current_profile_id and current_profile_id == p.id %}selected{% endif %}>{{ p.profile_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    {% if movies and movies|length > 0 %}
        <div class="catalog-grid">
            {% for movie in movies %}
                <div class="card">
                    <a href="{{ url_for('movie_detail', movie_id=movie.id) }}" class="card-link">
                        <img src="{{ movie.image_url if movie.image_url else 'https://via.placeholder.com/300x450?text=' + movie.title }}" alt="{{ movie.title }}">
                    </a>

                    {% if movie.imdb_rating %}
                    <div class="card-rating">
                        <i class="fas fa-star"></i> {{ movie.imdb_rating }}
                    </div>
                    {% endif %}

                    <div class="card-body">
                        <h3 class="card-title">{{ movie.title }}</h3>
                        <p class="card-desc">{{ movie.release_year }} • {{ movie.age_rating }}</p>
                        <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                            {% if current_user.is_authenticated %}
                                <button class="btn btn-sm btn-outline-light btn-add-watchlist" data-id="{{ movie.id }}" data-type="movie">Añadir a Mi Lista</button>
                            {% else %}
                                <a class="btn btn-sm btn-outline-light" href="{{ url_for('login') }}">Inicia sesión para guardar</a>
                            {% endif %}
                            <a class="btn btn-sm btn-light" href="{{ url_for('play_movie', movie_id=movie.id) }}">Ver</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="catalog-empty">
            <i class="fas fa-video-slash"></i>
            <h3>No hay películas disponibles</h3>
            <p>Vuelve más tarde para ver nuevo contenido.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Añadir a Mi Lista para películas
    document.querySelectorAll('.btn-add-watchlist').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const contentId = this.dataset.id;
            const contentType = this.dataset.type;
            this.disabled = true;
            const original = this.innerText;
            this.innerText = 'Guardando...';
            try {
                        // Obtener profile seleccionado si existe
                        const profileSelect = document.getElementById('profile-select');
                        const profileId = profileSelect ? profileSelect.value : null;

                        const payload = { content_id: contentId, content_type: contentType };
                        if (profileId) payload.profile_id = parseInt(profileId);

                        const res = await fetch('{{ url_for("add_to_watchlist") }}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                const data = await res.json();
                if (res.ok && data.success) {
                    showToast(data.message || 'Agregado a tu lista', 'success');
                    this.innerText = 'Guardado';
                } else {
                    showToast(data.message || 'No se pudo agregar', 'warning');
                    this.innerText = original;
                    this.disabled = false;
                }
            } catch (err) {
                console.error(err);
                showToast('Error de red al guardar', 'danger');
                this.innerText = original;
                this.disabled = false;
            }
        });
    });
</script>
{% endblock %}